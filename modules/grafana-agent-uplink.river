/********************************************
 * ARGUMENTS
 ********************************************/

argument "token" { }

argument "site" { }

argument "stack_name" {
	optional = true
	default  = "cminformatik"
}

/********************************************
 * EXPORTS
 ********************************************/

export "metrics_receiver" {
	value = prometheus.relabel.add_default_labels.receiver
}

export "logs_receiver" {
	value = loki.process.default_processing.receiver
}

// export "traces_receiver" {
//   value = otelcol.exporter.otlp.default.input
// }



/********************************************
 * OPEN TELEMTRY RESOURCES
 ********************************************/

 otelcol.receiver.otlp "default" {
	grpc { }
	http { }

	output {
		metrics = [otelcol.processor.batch.default.input]
		logs    = [otelcol.processor.batch.default.input]
		traces  = [otelcol.processor.batch.default.input]
	}
}

otelcol.processor.batch "default" {
	output {
		metrics = [otelcol.exporter.prometheus.grafana_cloud_prometheus.input]
		logs    = [otelcol.exporter.loki.grafana_cloud_loki.input]
		traces  = [module.git.grafana_cloud.exports.traces_receiver]
	}
}

otelcol.exporter.loki "default" {
	forward_to = [loki.process.default_processing.receiver]
}

otelcol.exporter.prometheus "default" {
	forward_to = [prometheus.relabel.add_default_labels.receiver]
}

/********************************************
 * UPLINK RESOURCES
 ********************************************/

loki.process "default_processing" {
	forward_to = [
		loki.relabel.add_default_lables.receiver,
	]

	stage.json {
		expressions = {"extracted_source" = "source"}
	}

	stage.labels {
		values = {"source" = "extracted_source"}
	}
}

loki.relabel "add_default_lables" {
	forward_to = [
		module.git.grafana_cloud.exports.logs_receiver,
	]

	rule {
		target_label = "site"
		replacement  = argument.site.value
	}

	rule {
		source_labels = ["__host__"]
		target_label  = "agent_hostname"
	}
}

prometheus.relabel "add_default_labels" {
	rule {
		source_labels = ["instance"]
		target_label  = "agent_hostname"
	}

	rule {
		target_label = "site"
		replacement  = argument.site.value
	}

	rule {
		source_labels = ["job"]
		regex         = "integrations/windows"
		action        = "replace"
		target_label  = "job"
		replacement   = "integrations/windows_exporter"
	}
	forward_to = [
		module.git.grafana_cloud.exports.metrics_receiver,
	]
}

module.git "grafana_cloud" {
	repository = "https://github.com/grafana/agent-modules.git"
	path       = "modules/grafana-cloud/autoconfigure/module.river"
	revision   = "main"

	arguments {
		stack_name = argument.stack_name.value
		token      = argument.token.value
	}
}