argument "token" {}

argument "environment" {}

export "metrics_receiver" {
  value = prometheus.relabel.add_default_labels.receiver
}

export "logs_receiver" {
  value = loki.process.default_processing.receiver
}

// export "traces_receiver" {
//   value = otelcol.exporter.otlp.default.input
// }

loki.process "default_processing" {
  forward_to = [
    loki.relabel.add_default_lables.receiver,
  ]

  stage.json {
      expressions = { "extracted_source" = "source" }
  }

  stage.labels {
      values = { "source" = "extracted_source" }
  }
}

loki.relabel "add_default_lables" {
  forward_to = [
    module.git.grafana_cloud.exports.logs_receiver,
  ]
  rule {
    target_label = "cloud_environment"
    replacement = argument.environment.value
  }

}

prometheus.relabel "add_default_labels" {
  rule {
    source_labels = ["instance"]
    target_label  = "agent_hostname"
  }
  rule {
    target_label = "cloud_environment"
    replacement = argument.environment.value
  }
  forward_to = [
    module.git.grafana_cloud.exports.metrics_receiver,
  ]
}


module.git "grafana_cloud" {
  repository = "https://github.com/grafana/agent-modules.git"
  path = "modules/grafana-cloud/autoconfigure/module.river"
  revision = "main"
  arguments {
    stack_name = "cminformatiktesting"
    token = argument.token.value
  }
}